{% extends 'base.html' %}
{% block title %}Añadir comida{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Añadir comida</h2>

  <!-- Mensajes flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }} mb-2">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" id="add-meal-form">
    <!-- Buscador de alimentos -->
    <div class="mb-3 position-relative">
      <label for="food-search" class="form-label">Buscar alimento</label>
      <input 
        type="text" 
        id="food-search" 
        class="form-control" 
        placeholder="Escribe al menos 2 letras..."
        autocomplete="off">
      <ul id="suggestions" 
          class="list-group position-absolute w-100"
          style="z-index:1000; max-height:200px; overflow-y:auto;"></ul>
      <input type="hidden" name="food_id" id="food-id">
    </div>

    <!-- Cantidad -->
    <div class="mb-3">
      <label for="quantity" class="form-label">Cantidad</label>
      <input 
        type="number" 
        name="quantity" 
        id="quantity" 
        class="form-control" 
        step="any" 
        min="0.1"
        required>
    </div>

    <!-- Tipo de comida -->
    <div class="mb-3">
      <label for="meal_type" class="form-label">Tipo de comida</label>
      <select name="meal_type" id="meal_type" class="form-select" required>
        <option value="desayuno">Desayuno</option>
        <option value="comida">Comida</option>
        <option value="merienda">Merienda</option>
        <option value="cena">Cena</option>
      </select>
    </div>

    <!-- Botones -->
    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">Añadir al diario</button>
      <button type="button" id="btn-create-food" class="btn btn-secondary">+ Crear alimento</button>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('food-search');
  const suggestionsBox = document.getElementById('suggestions');
  const foodIdInput = document.getElementById('food-id');
  let debounceTimer;

  // Autocompletado de alimentos
  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    const q = searchInput.value.trim();

    if (q.length < 2) {
      suggestionsBox.innerHTML = '';
      foodIdInput.value = '';
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/api/foods?search=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
          suggestionsBox.innerHTML = '';

          if (data.foods.length === 0) {
            const li = document.createElement('li');
            li.className = 'list-group-item text-muted';
            li.textContent = "No se encontraron alimentos.";
            suggestionsBox.appendChild(li);
            return;
          }

          data.foods.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.innerHTML = `<strong>${item.name}</strong> <small class="text-muted">(${item.macros_per_100g.kcal || 0} kcal/100g)</small>`;
            li.style.cursor = 'pointer';
            li.onclick = () => {
              searchInput.value = item.name;
              foodIdInput.value = item.id;
              suggestionsBox.innerHTML = '';
            };
            suggestionsBox.appendChild(li);
          });
        });
    }, 300);
  });

  // Cerrar sugerencias si se hace clic fuera
  document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.innerHTML = '';
    }
  });

  // Botón "Crear alimento" → por ahora solo placeholder
  document.getElementById('btn-create-food').addEventListener('click', () => {
    alert('Aquí se abrirá el modal para crear un nuevo alimento.');
  });
});
</script>
{% endblock %}
