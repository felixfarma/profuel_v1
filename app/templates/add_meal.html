<!-- app/templates/add_meal.html -->
{% extends 'base.html' %}
{% block title %}A√±adir comida{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Diario de hoy</h2>

  <!-- Listado de comidas de hoy -->
  <div class="mb-4">
    <h5>Comidas a√±adidas</h5>
    <div id="today-meals-list">
      {% for m in meals %}
      <div class="d-flex justify-content-between align-items-center py-1 border-bottom" data-meal-id="{{ m.id }}">
        <div>
          <span class="meal-time">{{ m.time }}</span> ‚Äî
          <span class="meal-name">{{ m.food.name }}</span>
          (<span class="meal-quantity">{{ m.quantity }}</span>)
        </div>
        <div>
          <span class="meal-calories">{{ m.calories }}</span> kcal
          <button class="btn btn-sm btn-link edit-meal">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-link text-danger delete-meal">üóëÔ∏è</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Totales -->
  <div class="mb-4">
    <h5>Totales</h5>
    <ul class="list-unstyled">
      <li>Kcal: <span id="total-kcal">{{ total_kcal }}</span></li>
      <li>Prote√≠nas: <span id="total-protein">{{ total_proteinas }}</span> g</li>
      <li>Carbs: <span id="total-carbs">{{ total_carbs }}</span> g</li>
      <li>Grasas: <span id="total-fats">{{ total_grasas }}</span> g</li>
    </ul>
  </div>

  <!-- Formulario AJAX de a√±adir comida -->
  <form id="add-meal-form" class="mb-5">
    <div class="mb-3 position-relative">
      <label for="food-search" class="form-label">Buscar alimento</label>
      <input
        type="text"
        id="food-search"
        class="form-control"
        placeholder="Escribe al menos 2 letras"
        autocomplete="off">
      <ul
        id="suggestions"
        class="list-group position-absolute w-100"
        style="z-index:1000; max-height:200px; overflow-y:auto;"></ul>
      <input type="hidden" name="food_id" id="food-id">
    </div>

    <div class="mb-3">
      <label for="quantity" class="form-label">Cantidad</label>
      <input
        type="number"
        name="quantity"
        id="quantity"
        class="form-control"
        step="any"
        min="0.01"
        required>
    </div>

    <div class="mb-3">
      <label for="meal_type" class="form-label">Tipo de comida</label>
      <select name="meal_type" id="meal_type" class="form-select" required>
        <option value="desayuno">Desayuno</option>
        <option value="comida">Comida</option>
        <option value="merienda">Merienda</option>
        <option value="cena">Cena</option>
      </select>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">A√±adir al diario</button>
      <button
        type="button"
        class="btn btn-secondary"
        data-bs-toggle="modal"
        data-bs-target="#foodModal">
        + Crear alimento
      </button>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">Volver</a>
    </div>
  </form>
</div>

<!-- Modal de creaci√≥n de alimento -->
<div class="modal fade" id="foodModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form id="create-food-form">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear nuevo alimento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" id="food-name" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Unidad</label>
              <select id="food-unit" class="form-select">
                <option value="g">g</option>
                <option value="ml">ml</option>
                <option value="unit">unidad</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Cantidad base</label>
              <input type="number" id="food-quantity" class="form-control" step="any" value="100" required>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col"><label class="form-label">Kcal/100g</label><input type="number" id="food-kcal100" class="form-control" step="any"></div>
            <div class="col"><label class="form-label">Prot/100g</label><input type="number" id="food-prot100" class="form-control" step="any"></div>
            <div class="col"><label class="form-label">Carbs/100g</label><input type="number" id="food-carbs100" class="form-control" step="any"></div>
            <div class="col"><label class="form-label">Fat/100g</label><input type="number" id="food-fat100" class="form-control" step="any"></div>
          </div>
          <div class="row g-3">
            <div class="col"><label class="form-label">Kcal/unidad</label><input type="number" id="food-kcal1" class="form-control" step="any"></div>
            <div class="col"><label class="form-label">Prot/unidad</label><input type="number" id="food-prot1" class="form-control" step="any"></div>
            <div class="col"><label class="form-label">Carbs/unidad</label><input type="number" id="food-carbs1" class="form-control" step="any"></div>
            <div class="col"><label class="form-label">Fat/unidad</label><input type="number" id="food-fat1" class="form-control" step="any"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Guardar alimento</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput    = document.getElementById('food-search');
  const suggestionsBox = document.getElementById('suggestions');
  const foodIdInput    = document.getElementById('food-id');
  let debounceTimer;

  // Autocompletado
  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    const q = searchInput.value.trim();
    if (q.length < 2) {
      suggestionsBox.innerHTML = '';
      foodIdInput.value = '';
      return;
    }
    debounceTimer = setTimeout(() => {
      fetch(`/api/foods?search=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
          suggestionsBox.innerHTML = '';
          if (!data.foods.length) {
            suggestionsBox.innerHTML = '<li class="list-group-item text-muted">No se encontraron alimentos.</li>';
            return;
          }
          data.foods.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.innerHTML = `<strong>${item.name}</strong> <small class="text-muted">(${item.macros_per_100g.kcal} kcal/100g)</small>`;
            li.style.cursor = 'pointer';
            li.addEventListener('click', () => {
              searchInput.value = item.name;
              foodIdInput.value = item.id;
              suggestionsBox.innerHTML = '';
            });
            suggestionsBox.appendChild(li);
          });
        });
    }, 300);
  });

  document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.innerHTML = '';
    }
  });

  // Crear alimento desde modal
  document.getElementById('create-food-form').addEventListener('submit', e => {
    e.preventDefault();
    const payload = {
      name: document.getElementById('food-name').value.trim(),
      default_unit: document.getElementById('food-unit').value,
      default_quantity: parseFloat(document.getElementById('food-quantity').value),
      kcal_per_100g: parseFloat(document.getElementById('food-kcal100').value) || 0,
      protein_per_100g: parseFloat(document.getElementById('food-prot100').value) || 0,
      carbs_per_100g: parseFloat(document.getElementById('food-carbs100').value) || 0,
      fat_per_100g: parseFloat(document.getElementById('food-fat100').value) || 0,
      kcal_per_unit: parseFloat(document.getElementById('food-kcal1').value) || null,
      protein_per_unit: parseFloat(document.getElementById('food-prot1').value) || null,
      carbs_per_unit: parseFloat(document.getElementById('food-carbs1').value) || null,
      fat_per_unit: parseFloat(document.getElementById('food-fat1').value) || null
    };
    fetch('/api/foods', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.ok ? r.json() : r.json().then(e => Promise.reject(e)))
    .then(data => {
      searchInput.value = data.food.name;
      foodIdInput.value = data.food.id;
      bootstrap.Modal.getInstance(document.getElementById('foodModal')).hide();
    })
    .catch(err => alert(err.error || 'Error al crear el alimento'));
  });

  // A√±adir comida (POST AJAX)
  document.getElementById('add-meal-form').addEventListener('submit', e => {
    e.preventDefault();
    const payload = {
      food_id: parseInt(foodIdInput.value),
      quantity: parseFloat(document.getElementById('quantity').value),
      meal_type: document.getElementById('meal_type').value
    };
    fetch('/api/meals', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(payload)
    })
    .then(r => r.ok ? r.json() : r.json().then(e => Promise.reject(e)))
    .then(({ meal }) => {
      // A√±adir fila nueva
      const list = document.getElementById('today-meals-list');
      const row = document.createElement('div');
      row.className = 'd-flex justify-content-between align-items-center py-1 border-bottom';
      row.setAttribute('data-meal-id', meal.id);
      row.innerHTML = `
        <div>
          <span class="meal-time">${meal.time}</span> ‚Äî
          <span class="meal-name">${meal.food.name}</span>
          (<span class="meal-quantity">${meal.quantity}</span>)
        </div>
        <div>
          <span class="meal-calories">${meal.calories}</span> kcal
          <button class="btn btn-sm btn-link edit-meal">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-link text-danger delete-meal">üóëÔ∏è</button>
        </div>`;
      list.appendChild(row);

      // Actualizar totales
      document.getElementById('total-kcal').textContent =
        parseInt(document.getElementById('total-kcal').textContent) + meal.calories;
      document.getElementById('total-protein').textContent =
        parseInt(document.getElementById('total-protein').textContent) + meal.protein;
      document.getElementById('total-carbs').textContent =
        parseInt(document.getElementById('total-carbs').textContent) + meal.carbs;
      document.getElementById('total-fats').textContent =
        parseInt(document.getElementById('total-fats').textContent) + meal.fats;

      // Reset form
      searchInput.value = '';
      foodIdInput.value = '';
      document.getElementById('quantity').value = '';
      suggestionsBox.innerHTML = '';
    })
    .catch(err => alert(err.error || 'Error al a√±adir comida'));
  });

  // Borrar comida (DELETE AJAX)
  document.getElementById('today-meals-list').addEventListener('click', e => {
    if (!e.target.matches('.delete-meal')) return;
    const row = e.target.closest('[data-meal-id]');
    const id  = row.dataset.mealId;
    fetch(`/api/meals/${id}`, { method: 'DELETE' })
      .then(r => {
        if (r.ok) {
          const kcal = parseInt(row.querySelector('.meal-calories').textContent);
          document.getElementById('total-kcal').textContent =
            parseInt(document.getElementById('total-kcal').textContent) - kcal;
          row.remove();
        } else {
          return r.json().then(err => Promise.reject(err));
        }
      })
      .catch(err => alert(err.error || 'Error al borrar comida'));
  });

  // Editar comida (PUT AJAX)
  document.getElementById('today-meals-list').addEventListener('click', e => {
    if (!e.target.matches('.edit-meal')) return;
    const row        = e.target.closest('[data-meal-id]');
    const id         = row.dataset.mealId;
    const qtySpan    = row.querySelector('.meal-quantity');
    const calSpan    = row.querySelector('.meal-calories');
    const oldQty     = parseFloat(qtySpan.textContent);
    const oldCal     = parseInt(calSpan.textContent);
    const newQtyStr  = prompt('Nueva cantidad:', oldQty);
    if (newQtyStr === null) return;
    const newQty = parseFloat(newQtyStr);
    if (isNaN(newQty) || newQty <= 0) {
      return alert('Cantidad inv√°lida');
    }

    fetch(`/api/meals/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ quantity: newQty })
    })
    .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
    .then(({ meal }) => {
      qtySpan.textContent = meal.quantity;
      calSpan.textContent = meal.calories;
      const diff = meal.calories - oldCal;
      document.getElementById('total-kcal').textContent =
        parseInt(document.getElementById('total-kcal').textContent) + diff;
    })
    .catch(err => alert(err.error || 'Error al editar comida'));
  });
});
</script>
{% endblock %}
