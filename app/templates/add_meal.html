<!-- app/templates/add_meal.html -->

{% extends 'base.html' %}
{% block title %}Añadir comida{% endblock %}
{% block content %}
<div class="container mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h2>Añadir comida</h2>
  <form id="add-meal-form" method="POST" action="{{ url_for('nutrition.new_meal') }}">
    {{ form.hidden_tag() }}

    <!-- Fecha -->
    <div class="mb-3">
      {{ form.date.label(class="form-label") }}
      {{ form.date(class="form-control") }}
      {% for err in form.date.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
    </div>

    <!-- Hora -->
    <div class="mb-3">
      {{ form.time.label(class="form-label") }}
      {{ form.time(class="form-control") }}
      {% for err in form.time.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
    </div>

    <!-- Alimento: búsqueda + hidden -->
    <div class="mb-3 position-relative">
      {{ form.food_name.label(class="form-label") }}
      {{ form.food_name(class="form-control", id="food-search", autocomplete="off", placeholder="Escribe para buscar...") }}
      {{ form.food_id(id="food-id") }}
      <ul id="suggestions" class="list-group position-absolute w-100"
          style="z-index:1000; max-height:200px; overflow-y:auto;"></ul>
      {% for err in form.food_name.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
      {% for err in form.food_id.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
    </div>

    <!-- Cantidad -->
    <div class="mb-3">
      {{ form.quantity.label(class="form-label") }}
      {{ form.quantity(class="form-control", step="any") }}
      {% for err in form.quantity.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
    </div>

    <!-- Tipo de comida -->
    <div class="mb-3">
      {{ form.meal_type.label(class="form-label") }}
      {{ form.meal_type(class="form-select") }}
      {% for err in form.meal_type.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
    </div>

    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary ms-2">Volver al Dashboard</a>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput    = document.getElementById('food-search');
  const idInput        = document.getElementById('food-id');
  const suggestionsBox = document.getElementById('suggestions');
  let debounceTimer;

  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    const q = searchInput.value.trim();
    if (q.length < 2) {
      suggestionsBox.innerHTML = '';
      idInput.value = '';
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/api/foods?search=${encodeURIComponent(q)}`, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      })
      .then(r => r.json())
      .then(data => {
        suggestionsBox.innerHTML = '';
        data.foods.concat(data.suggestions).forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action';
          li.textContent = `${item.name} — ${item.macros_per_100g.kcal || item.macros_per_unit.kcal} kcal`;
          li.style.cursor = 'pointer';
          li.onclick = () => {
            searchInput.value = item.name;
            idInput.value     = item.id;
            suggestionsBox.innerHTML = '';
          };
          suggestionsBox.append(li);
        });
      });
    }, 300);
  });

  document.addEventListener('click', e => {
    if (!searchInput.contains(e.target)) {
      suggestionsBox.innerHTML = '';
    }
  });
});
</script>
{% endblock %}
