{% extends 'base.html' %}

{% block content %}
  <h2>Dashboard de {{ current_user.email }}</h2>
  <p><strong>Fecha:</strong> {{ hoy.strftime('%Y-%m-%d') }}</p>
  <p><strong>Edad:</strong> {{ edad }} años</p>
  <p><strong>BMR:</strong> {{ bmr }} kcal</p>
  <p><strong>TDEE:</strong> {{ tdee }} kcal</p>

  <h3>Comidas de hoy</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Hora</th><th>Alimento</th><th>Cantidad</th>
        <th>Kcal</th><th>Proteína</th><th>Carbs</th>
        <th>Grasas</th><th>Tipo</th>
      </tr>
    </thead>
    <tbody>
      {% for m in meals %}
        <tr>
          <td>{{ m.time.strftime('%H:%M') }}</td>
          <td>{{ m.food.name }}</td>
          <td>{{ m.quantity }}</td>
          <td>{{ m.calories }}</td>
          <td>{{ m.protein }}</td>
          <td>{{ m.carbs }}</td>
          <td>{{ m.fats }}</td>
          <td>{{ m.meal_type }}</td>
        </tr>
      {% else %}
        <tr><td colspan="8">No hay comidas hoy.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h4>Totales diarios</h4>
  <ul>
    <li><strong>Kcal totales:</strong> {{ total_kcal }}</li>
    <li><strong>Proteínas:</strong> {{ total_proteinas }} g</li>
    <li><strong>Carbs:</strong> {{ total_carbs }} g</li>
    <li><strong>Grasas:</strong> {{ total_grasas }} g</li>
  </ul>

  <hr>

  <div class="row">
    <div class="col-md-6">
      <h5>Macros por comida</h5>
      <canvas id="macroChart"></canvas>
    </div>
    <div class="col-md-6">
      <h5>Calorías vs Objetivo</h5>
      <canvas id="calorieChart"></canvas>
    </div>
  </div>

  <!-- Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Configuración del gráfico de macros apilado
    const macroCtx = document.getElementById('macroChart').getContext('2d');
    new Chart(macroCtx, {
      type: 'bar',
      data: {
        labels: {{ chart_labels|tojson }},
        datasets: [
          {
            label: 'Proteínas (g)',
            data: {{ chart_proteinas|tojson }},
            backgroundColor: 'rgba(75, 192, 192, 0.6)'
          },
          {
            label: 'Carbs (g)',
            data: {{ chart_carbs|tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          },
          {
            label: 'Grasas (g)',
            data: {{ chart_grasas|tojson }},
            backgroundColor: 'rgba(255, 206, 86, 0.6)'
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: {
            stacked: true,
            beginAtZero: true,
            title: { display: true, text: 'Gramos' }
          }
        }
      }
    });

    // Configuración del gráfico de calorías vs objetivo
    const calCtx = document.getElementById('calorieChart').getContext('2d');
    new Chart(calCtx, {
      type: 'bar',
      data: {
        labels: ['Consumido', 'Objetivo'],
        datasets: [{
          label: 'Calorías',
          data: {{ chart_calories|tojson }},
          backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(153, 102, 255, 0.6)']
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'kcal' }
          }
        }
      }
    });
  </script>
{% endblock %}
